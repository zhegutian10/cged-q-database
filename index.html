
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清代官员信息可视化系统 - CGED-Q</title>
    <script src="lib/echarts.min.js"></script> 
    <script src="lib/papaparse.min.js"></script>
    <script>
        // 注册中国地图数据 - 使用本地文件（最可靠）
        let chinaMapLoaded = false;
        
        async function loadChinaMap() {
            try {
                console.log('正在加载本地地图数据...');
                const response = await fetch('china.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                
                const data = await response.json();
                echarts.registerMap('china', data);
                chinaMapLoaded = true;
                console.log('✅ 地图数据加载成功（本地文件）');
                return true;
            } catch (err) {
                console.error('❌ 地图数据加载失败:', err);
                console.error('请确保 china.json 文件已上传到GitHub仓库根目录');
                return false;
            }
        }
        
        // 页面加载时加载地图
        loadChinaMap();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', 'STSong', 'SimSun', serif;
            background: #1a1a1a;
            min-height: 100vh;
            color: #333;
        }

        /* 首页样式 */
        .hero-section {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* 移轴效果背景层 - 从左上到右下的透视滚动 */
        .parallax-bg {
            position: absolute;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background: url('back.jpg') no-repeat;
            background-size: cover;
            animation: parallaxScroll 60s ease-in-out infinite;
            z-index: 0;
            will-change: transform;
        }

        @keyframes parallaxScroll {
            0% {
                transform: translate(0, 0) scale(1.1);
            }
            50% {
                transform: translate(-8%, -8%) scale(1.15);
            }
            100% {
                transform: translate(0, 0) scale(1.1);
            }
        }

        /* 遮罩层 */
        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1;
        }

        /* 内容层 */
        .hero-content {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .logo {
            position: absolute;
            top: 30px;
            left: 40px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: #c8102e;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .logo-text {
            color: white;
            font-size: 18px;
            letter-spacing: 2px;
        }

        .hero-title {
            font-size: 4em;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            margin-top: -80px;
            font-weight: 300;
            letter-spacing: 8px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
        }

        .hero-subtitle {
            font-size: 1.2em;
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 60px;
            letter-spacing: 3px;
        }

        .search-container {
            display: flex;
            gap: 0;
            max-width: 700px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 100px;
        }

        .search-input {
            flex: 1;
            padding: 20px 30px;
            border: none;
            font-size: 16px;
            background: white;
            border-radius: 0;
            outline: none;
        }

        .search-button {
            padding: 20px 50px;
            background: #c8102e;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .search-button:hover {
            background: #a00d24;
        }

        .stats-bar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 100px;
            color: white;
            z-index: 10;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #c8102e;
        }

        .stat-label {
            font-size: 0.9em;
            margin-top: 5px;
            opacity: 0.8;
            letter-spacing: 2px;
        }

        /* 内容区域 */
        .content-wrapper {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
        }

        /* 内容页顶部搜索区 - 重新设计 */
        .content-header {
            background: white;
            padding: 25px 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border-bottom: 1px solid #e9ecef;
        }

        .content-search-box {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .content-search-input {
            flex: 1;
            padding: 18px 30px;
            border: none;
            font-size: 16px;
            outline: none;
            background: white;
        }

        .content-search-button {
            padding: 18px 50px;
            background: #c8102e;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .content-search-button:hover {
            background: #a00d24;
        }

        .content-search-button.secondary {
            background: #666;
        }

        .content-search-button.secondary:hover {
            background: #555;
        }

        .content-body {
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            background: white;
            padding: 30px 40px;
            margin-bottom: 30px;
            border-left: 5px solid #c8102e;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .page-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        .page-subtitle {
            color: #666;
            font-size: 1em;
            letter-spacing: 1px;
        }

        .back-button {
            display: inline-block;
            padding: 12px 30px;
            background: #666;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.3s;
            letter-spacing: 1px;
        }

        .back-button:hover {
            background: #555;
        }

        /* 官员列表 */
        .official-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .official-card {
            background: white;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .official-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-bottom-color: #c8102e;
        }

        .official-card-name {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .official-card-info {
            color: #666;
            font-size: 0.95em;
            line-height: 1.8;
        }

        .official-card-info span {
            display: block;
            margin: 5px 0;
        }

        /* 信息卡片 */
        .info-card {
            background: white;
            padding: 35px;
            margin-bottom: 30px;
            border-left: 5px solid #c8102e;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .info-card h2 {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 25px;
            letter-spacing: 3px;
            font-weight: 500;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-item {
            padding: 20px;
            background: #fafafa;
            border-left: 3px solid #c8102e;
            transition: all 0.3s;
        }

        .info-item:hover {
            background: #f5f5f5;
            transform: translateX(5px);
        }

        .info-label {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }

        /* 标签页 */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .tab {
            flex: 1;
            padding: 18px 30px;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            letter-spacing: 2px;
        }

        .tab.active {
            color: #c8102e;
            border-bottom-color: #c8102e;
            font-weight: bold;
        }

        .tab:hover {
            color: #c8102e;
            background: #fafafa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            width: 100%;
            height: 600px;
            min-height: 600px;
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* 网络图例 */
        .network-legend {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 20px;
            background: #fafafa;
            border-left: 3px solid #c8102e;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
        }

        .legend-label {
            font-size: 0.9em;
            color: #666;
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 100px 20px;
            color: white;
            font-size: 1.3em;
            letter-spacing: 2px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(200, 16, 46, 0.2);
            border-top-color: #c8102e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 提示信息 */
        .alert {
            padding: 20px 30px;
            margin-bottom: 20px;
            border-left: 5px solid #c8102e;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .alert-success {
            border-left-color: #28a745;
        }

        .alert-warning {
            border-left-color: #ffc107;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5em;
                letter-spacing: 4px;
            }

            .stats-bar {
                flex-direction: column;
                gap: 30px;
            }

            .official-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 首页 -->
    <div id="heroSection" class="hero-section">
        <!-- 移轴背景层 -->
        <div class="parallax-bg" id="parallaxBg"></div>
        
        <!-- 遮罩层 -->
        <div class="hero-overlay"></div>
        
        <!-- Logo - 独立于内容层 -->
        <div class="logo">
            <div class="logo-icon">清</div>
            <div class="logo-text">CGED-Q</div>
        </div>
        
        <!-- 内容层 -->
        <div class="hero-content">
            <h1 class="hero-title">清代官员数据库</h1>
            <p class="hero-subtitle">中国历史官员量化数据库公开版</p>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="请输入官员姓名、官职或籍贯...">
                <button onclick="searchOfficial()" class="search-button">搜索</button>
            </div>
        </div>
        
        <!-- 统计信息 - 独立于内容层 -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-number" id="statRecords">-</div>
                <div class="stat-label">官员记录</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statOfficials">-</div>
                <div class="stat-label">不同官员</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">1760-1798</div>
                <div class="stat-label">年份范围</div>
            </div>
        </div>
    </div>

    <!-- 官员列表页 -->
    <div id="officialListPage" class="content-wrapper" style="display: none;">
        <div class="content-header">
            <div class="content-search-box">
                <input type="text" id="searchInput2" class="content-search-input" placeholder="请输入官员姓名、官职或籍贯...">
                <button onclick="searchOfficialFromContent()" class="content-search-button">搜索</button>
                <button onclick="backToHome()" class="content-search-button secondary">返回首页</button>
            </div>
        </div>
        <div class="content-body">
            <div class="container">
                <div class="page-header">
                    <h1 class="page-title">官员列表</h1>
                    <p class="page-subtitle" id="listSubtitle">共找到 0 位官员</p>
                </div>

                <div id="officialGrid" class="official-grid"></div>
            </div>
        </div>
    </div>

    <!-- 官员详情页 -->
    <div id="officialDetailPage" class="content-wrapper" style="display: none;">
        <div class="content-header">
            <div class="content-search-box">
                <input type="text" id="searchInput3" class="content-search-input" placeholder="请输入官员姓名、官职或籍贯...">
                <button onclick="searchOfficialFromContent()" class="content-search-button">搜索</button>
                <button onclick="goBack()" class="content-search-button secondary">返回</button>
            </div>
        </div>
        <div class="content-body">
            <div class="container">
                <!-- 基本信息 -->
            <div class="info-card">
                <h2>基本信息</h2>
                <div class="info-grid" id="basicInfo"></div>
            </div>

            <!-- 可视化分析 -->
            <div class="info-card">
                <h2>可视化分析</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('timeline')">仕途时间线</button>
                    <button class="tab" onclick="switchTab('map')">地理轨迹</button>
                    <button class="tab" onclick="switchTab('rank')">品级变化</button>
                    <button class="tab" onclick="switchTab('network')">社交网络</button>
                </div>

                <div id="timeline" class="tab-content active">
                    <div class="chart-container" id="timelineChart"></div>
                </div>

                <div id="map" class="tab-content">
                    <div class="chart-container" id="mapChart"></div>
                </div>

                <div id="rank" class="tab-content">
                    <div class="chart-container" id="rankChart"></div>
                </div>

                <div id="network" class="tab-content">
                    <div class="network-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #5470c6;"></div>
                            <span class="legend-label">同机构关系</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #91cc75;"></div>
                            <span class="legend-label">同乡关系</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fac858;"></div>
                            <span class="legend-label">同期关系</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ee6666;"></div>
                            <span class="legend-label">师生关系</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #73c0de;"></div>
                            <span class="legend-label">家族关系</span>
                        </div>
                    </div>
                    <div class="chart-container" id="networkChart"></div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loadingMsg" class="loading">
        <div class="loading-spinner"></div>
        正在加载数据，请稍候...
    </div>

    <script>
        let allData = [];
        let officialHistory = [];
        let currentOfficial = null;
        let currentPage = 'hero'; // hero, list, detail

        // 加载数据
        async function loadData() {
            try {
                console.log('开始加载数据...');
                
                const response = await fetch('data/CGED-Q Public Release 1760-1798  1 Jul 2024.tab');
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                let text;
                let usedEncoding = 'UTF-8';
                
                try {
                    const encodings = ['utf-8', 'gbk', 'gb2312', 'gb18030'];
                    
                    for (const encoding of encodings) {
                        try {
                            const decoder = new TextDecoder(encoding);
                            const testText = decoder.decode(arrayBuffer);
                            const sample = testText.substring(0, 1000);
                            
                            if (!sample.includes('�') && /[\u4e00-\u9fa5]/.test(sample)) {
                                text = testText;
                                usedEncoding = encoding.toUpperCase();
                                console.log(`成功使用 ${usedEncoding} 编码解析`);
                                break;
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                    
                    if (!text) {
                        const decoder = new TextDecoder('utf-8');
                        text = decoder.decode(arrayBuffer);
                        usedEncoding = 'UTF-8 (fallback)';
                    }
                    
                } catch (e) {
                    console.error('编码转换错误:', e);
                    const decoder = new TextDecoder('utf-8');
                    text = decoder.decode(arrayBuffer);
                }
                
                Papa.parse(text, {
                    header: true,
                    delimiter: '\t',
                    skipEmptyLines: true,
                    complete: function(results) {
                        allData = results.data;
                        document.getElementById('loadingMsg').style.display = 'none';
                        
                        // 更新统计数据
                        updateStats();
                        
                        console.log('数据加载成功，共', allData.length, '条记录');
                    },
                    error: function(error) {
                        throw new Error('数据解析失败: ' + error.message);
                    }
                });
                
            } catch (error) {
                console.error('数据加载失败:', error);
                document.getElementById('loadingMsg').innerHTML = `
                    <div style="color: #c8102e; max-width: 600px; margin: 0 auto;">
                        <h3 style="margin-bottom: 20px;">数据加载失败</h3>
                        <p>${error.message}</p>
                        <button onclick="loadData()" style="margin-top: 30px; padding: 15px 40px; background: #c8102e; color: white; border: none; cursor: pointer; font-size: 16px;">重新加载</button>
                    </div>
                `;
            }
        }

        // 更新统计数据
        function updateStats() {
            document.getElementById('statRecords').textContent = allData.length.toLocaleString();
            
            const uniqueOfficials = {};
            allData.forEach(item => {
                const name = (item['姓'] || '') + (item['名'] || '');
                if (name && name.trim() !== '') {
                    uniqueOfficials[name] = true;
                }
            });
            
            document.getElementById('statOfficials').textContent = Object.keys(uniqueOfficials).length.toLocaleString();
        }

        // 搜索官员（主搜索框）
        function searchOfficial() {
            performSearch('searchInput');
        }

        // 从内容页搜索
        function searchOfficialFromContent() {
            const inputId = currentPage === 'list' ? 'searchInput2' : 'searchInput3';
            performSearch(inputId);
        }

        // 执行搜索
        function performSearch(inputId) {
            const searchTerm = document.getElementById(inputId).value.trim();
            if (!searchTerm) {
                alert('请输入搜索内容');
                return;
            }

            if (allData.length === 0) {
                alert('数据尚未加载，请稍候...');
                return;
            }

            const results = allData.filter(item => {
                const fullName = (item['姓'] || '') + (item['名'] || '');
                const position = item['官职一'] || '';
                const region = (item['籍贯省'] || '') + (item['籍贯县'] || '');
                const organization = item['机构一'] || '';
                
                return fullName.includes(searchTerm) ||
                       position.includes(searchTerm) ||
                       region.includes(searchTerm) ||
                       organization.includes(searchTerm);
            });

            if (results.length === 0) {
                alert(`未找到包含"${searchTerm}"的相关官员`);
                return;
            }

            if (results.length === 1) {
                showOfficialDetails(results[0]);
            } else {
                showOfficialList(results);
            }
        }

        // 显示官员列表
        function showOfficialList(officials) {
            currentPage = 'list';
            document.getElementById('heroSection').style.display = 'none';
            document.getElementById('officialListPage').style.display = 'block';
            document.getElementById('officialDetailPage').style.display = 'none';

            // 去重
            const uniqueOfficials = {};
            officials.forEach(item => {
                const name = (item['姓'] || '') + (item['名'] || '');
                if (name && !uniqueOfficials[name]) {
                    uniqueOfficials[name] = item;
                }
            });

            const officialsList = Object.values(uniqueOfficials);
            document.getElementById('listSubtitle').textContent = `共找到 ${officialsList.length} 位官员`;

            const grid = document.getElementById('officialGrid');
            grid.innerHTML = officialsList.map((official, index) => {
                const officialIndex = allData.indexOf(official);
                return `
                    <div class="official-card" onclick="showOfficialDetails(allData[${officialIndex}])">
                        <div class="official-card-name">${official['姓'] || ''}${official['名'] || ''}</div>
                        <div class="official-card-info">
                            <span>📍 ${official['籍贯省'] || ''}${official['籍贯县'] || ''}</span>
                            <span>🏛️ ${official['官职一'] || '职位不详'}</span>
                            <span>📅 ${official['阳历年份'] || '未知'}年</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 返回首页
        function backToHome() {
            currentPage = 'hero';
            document.getElementById('heroSection').style.display = 'flex';
            document.getElementById('officialListPage').style.display = 'none';
            document.getElementById('officialDetailPage').style.display = 'none';
            document.getElementById('searchInput').value = '';
        }

        // 返回上一页
        function goBack() {
            if (officialHistory.length > 0) {
                const previousOfficial = officialHistory.pop();
                showOfficialDetails(previousOfficial, true);
            } else if (currentPage === 'detail') {
                backToHome();
            }
        }

        // 显示官员详情
        function showOfficialDetails(official, fromHistory = false) {
            if (!fromHistory && currentOfficial) {
                officialHistory.push(currentOfficial);
            }
            
            currentOfficial = official;
            currentPage = 'detail';
            
            document.getElementById('heroSection').style.display = 'none';
            document.getElementById('officialListPage').style.display = 'none';
            document.getElementById('officialDetailPage').style.display = 'block';

            showBasicInfo(official);

            const officialName = (official['姓'] || '') + (official['名'] || '');
            const allRecords = allData.filter(item =>
                (item['姓'] || '') + (item['名'] || '') === officialName
            );

            setTimeout(() => {
                drawTimeline(allRecords);
                drawMap(allRecords);
                drawRankChart(allRecords);
                drawNetworkChart(official, allData);
            }, 100);
        }

        // 显示基本信息
        function showBasicInfo(official) {
            const basicInfo = document.getElementById('basicInfo');
            const fields = [
                { label: '姓名', value: (official['姓'] || '') + (official['名'] || '') },
                { label: '字号', value: official['字号'] || '无' },
                { label: '籍贯', value: (official['籍贯省'] || '') + (official['籍贯县'] || '') },
                { label: '出身', value: official['出身一'] || '无' },
                { label: '科年', value: official['科年一'] || '无' },
                { label: '官职', value: official['官职一'] || '无' },
                { label: '机构', value: official['机构一'] || '无' },
                { label: '地区', value: official['地区'] || '无' },
                { label: '旗分', value: official['旗分'] || '无' },
                { label: '身份', value: (official['身份一'] || '') + (official['身份二'] || '') },
                { label: '爵位', value: official['爵位'] || '无' },
                { label: '年代', value: (official['阳历年份'] || '未知') + '年' }
            ];

            basicInfo.innerHTML = fields.map(field => `
                <div class="info-item">
                    <div class="info-label">${field.label}</div>
                    <div class="info-value">${field.value}</div>
                </div>
            `).join('');
        }

        // 绘制仕途时间线
        function drawTimeline(records) {
            const chartDom = document.getElementById('timelineChart');
            const oldChart = echarts.getInstanceByDom(chartDom);
            if (oldChart) {
                oldChart.dispose();
            }
            const chart = echarts.init(chartDom);
            
            const sortedRecords = records.sort((a, b) => a['阳历年份'] - b['阳历年份']);
            
            const timelineData = sortedRecords.map(record => ({
                name: (record['阳历年份'] || '未知') + '年',
                value: [
                    record['阳历年份'],
                    record['官职一'] || '未知职位',
                    record['地区'] || '未知地区',
                    record['机构一'] || '未知机构'
                ]
            }));

            const option = {
                title: {
                    text: '仕途时间线',
                    left: 'center',
                    textStyle: {
                        fontSize: 20,
                        fontWeight: 'normal'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0].data.value;
                        return `<strong>${params[0].name}</strong><br/>
                                职位: ${data[1]}<br/>
                                地区: ${data[2]}<br/>
                                机构: ${data[3]}`;
                    }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '15%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: timelineData.map(d => d.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    show: false
                },
                series: [{
                    type: 'line',
                    data: timelineData.map((d, i) => ({
                        value: [i, i, d.value[2], d.value[3]],
                        name: d.name
                    })),
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: '#c8102e'
                    },
                    itemStyle: {
                        color: '#c8102e',
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    symbolSize: 10,
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function(params) {
                            return timelineData[params.dataIndex].value[1];
                        },
                        fontSize: 10
                    }
                }]
            };

            chart.setOption(option);
        }

        // 清代主要地名坐标映射
        const qingLocationMap = {
            '北京': [116.4074, 39.9042], '顺天': [116.4074, 39.9042], '直隶': [116.4074, 39.9042],
            '天津': [117.2008, 39.0842], '保定': [115.4648, 38.8736],
            '河南': [113.6254, 34.7466], '开封': [114.3477, 34.7972],
            '山东': [117.0208, 36.6683], '济南': [117.1205, 36.6519],
            '山西': [112.5489, 37.8706], '太原': [112.5489, 37.8706],
            '陕西': [108.9540, 34.2656], '西安': [108.9540, 34.2656],
            '甘肃': [103.8236, 36.0581], '兰州': [103.8236, 36.0581],
            '江苏': [118.7969, 32.0603], '南京': [118.7969, 32.0603], '江宁': [118.7969, 32.0603], '苏州': [120.5954, 31.2989],
            '浙江': [120.1536, 30.2875], '杭州': [120.1536, 30.2875],
            '安徽': [117.2272, 31.8206],
            '江西': [115.8581, 28.6832], '南昌': [115.8581, 28.6832],
            '湖北': [114.3055, 30.5931], '武昌': [114.3055, 30.5931],
            '湖南': [112.9388, 28.2282], '长沙': [112.9388, 28.2282],
            '四川': [104.0665, 30.5723], '成都': [104.0665, 30.5723],
            '福建': [119.2965, 26.1004], '福州': [119.2965, 26.1004],
            '广东': [113.2644, 23.1291], '广州': [113.2644, 23.1291],
            '广西': [108.3661, 22.8172], '桂林': [110.2865, 25.2742],
            '云南': [102.7103, 25.0406], '昆明': [102.7103, 25.0406],
            '贵州': [106.7073, 26.5982], '贵阳': [106.7073, 26.5982],
            '奉天': [123.4328, 41.8045], '盛京': [123.4328, 41.8045],
            '吉林': [126.5494, 43.8380], '黑龙江': [126.6433, 45.7567],
            '新疆': [87.6278, 43.7928], '西藏': [91.1174, 29.6470], '拉萨': [91.1174, 29.6470],
            '蒙古': [111.6708, 40.8183], '热河': [117.9382, 40.9739], '察哈尔': [114.8750, 40.8183], '绥远': [111.6708, 40.8183]
        };

        // 绘制地理轨迹图
        function drawMap(records) {
            const chartDom = document.getElementById('mapChart');
            const oldChart = echarts.getInstanceByDom(chartDom);
            if (oldChart) oldChart.dispose();
            const chart = echarts.init(chartDom);
            
            // 检查地图是否加载成功
            if (!chinaMapLoaded) {
                chart.setOption({
                    title: {
                        text: '地理轨迹图',
                        subtext: '地图数据加载中，请稍候...',
                        left: 'center',
                        top: 'middle',
                        textStyle: { fontSize: 20, color: '#333' },
                        subtextStyle: { fontSize: 14, color: '#666' }
                    }
                });
                
                // 等待地图加载后重试
                setTimeout(() => {
                    if (chinaMapLoaded) {
                        drawMap(records);
                    } else {
                        chart.setOption({
                            title: {
                                text: '地理轨迹图',
                                subtext: '地图数据加载失败，请刷新页面重试或检查网络连接',
                                left: 'center',
                                top: 'middle',
                                textStyle: { fontSize: 20, color: '#c8102e' },
                                subtextStyle: { fontSize: 14, color: '#666' }
                            }
                        });
                    }
                }, 3000);
                return;
            }
            
            const sortedRecords = records.sort((a, b) => a['阳历年份'] - b['阳历年份']);
            const yearData = {};
            const allYears = [];
            
            // 虚拟地理轨迹数据（用于演示）
            const demoLocations = [
                { name: '北京', coords: [116.4074, 39.9042] },
                { name: '南京', coords: [118.7969, 32.0603] },
                { name: '杭州', coords: [120.1536, 30.2875] },
                { name: '广州', coords: [113.2644, 23.1291] },
                { name: '成都', coords: [104.0665, 30.5723] },
                { name: '西安', coords: [108.9540, 34.2656] },
                { name: '武昌', coords: [114.3055, 30.5931] },
                { name: '福州', coords: [119.2965, 26.1004] }
            ];
            
            let hasRealData = false;
            
            sortedRecords.forEach(record => {
                const region = record['地区'] || record['籍贯省'] || '未知';
                const year = record['阳历年份'];
                const position = record['官职一'] || '未知职位';
                
                let coords = null;
                for (const [place, coord] of Object.entries(qingLocationMap)) {
                    if (region.includes(place) || place.includes(region)) {
                        coords = coord;
                        hasRealData = true;
                        break;
                    }
                }
                
                if (coords && year) {
                    if (!yearData[year]) {
                        yearData[year] = [];
                        allYears.push(year);
                    }
                    yearData[year].push({
                        name: region,
                        value: coords,
                        position: position,
                        year: year
                    });
                }
            });
            
            // 如果没有真实地理数据，生成虚拟演示数据
            if (!hasRealData || allYears.length === 0) {
                console.log('未找到地理信息，生成虚拟演示数据');
                sortedRecords.forEach((record, index) => {
                    const year = record['阳历年份'];
                    const position = record['官职一'] || '未知职位';
                    
                    if (year) {
                        // 使用虚拟位置循环分配
                        const demoLocation = demoLocations[index % demoLocations.length];
                        
                        if (!yearData[year]) {
                            yearData[year] = [];
                            allYears.push(year);
                        }
                        
                        yearData[year].push({
                            name: demoLocation.name + '（演示）',
                            value: demoLocation.coords,
                            position: position,
                            year: year
                        });
                    }
                });
            }
            
            const sortedYears = allYears.sort((a, b) => a - b);
            
            // 确保至少有一些数据可以显示
            if (sortedYears.length === 0) {
                chart.setOption({
                    title: {
                        text: '地理轨迹图',
                        subtext: '该官员暂无可用的地理信息',
                        left: 'center',
                        top: 'middle',
                        textStyle: { fontSize: 20, color: '#666' },
                        subtextStyle: { fontSize: 14, color: '#999' }
                    }
                });
                return;
            }
            
            if (sortedYears.length > 0) {
                const options = sortedYears.map((year, yearIndex) => {
                    const yearPoints = yearData[year];
                    const lines = [];
                    if (yearIndex > 0) {
                        const prevYear = sortedYears[yearIndex - 1];
                        const prevPoints = yearData[prevYear];
                        if (prevPoints.length > 0 && yearPoints.length > 0) {
                            lines.push({
                                coords: [prevPoints[prevPoints.length - 1].value, yearPoints[0].value]
                            });
                        }
                    }
                    
                    return {
                        title: {
                            text: `地理轨迹 - ${year}年${!hasRealData ? '（演示数据）' : ''}`,
                            left: 'center',
                            top: 10,
                            textStyle: { fontSize: 18, color: '#333' },
                            subtext: !hasRealData ? '注：此为虚拟演示数据' : '',
                            subtextStyle: { fontSize: 12, color: '#999' }
                        },
                        series: [
                            {
                                name: '任职地点',
                                type: 'scatter',
                                coordinateSystem: 'geo',
                                data: yearPoints,
                                symbolSize: 25,
                                itemStyle: {
                                    color: '#c8102e',
                                    borderColor: '#fff',
                                    borderWidth: 3,
                                    shadowBlur: 10,
                                    shadowColor: 'rgba(200, 16, 46, 0.5)'
                                },
                                label: {
                                    show: true,
                                    position: 'right',
                                    formatter: '{b}',
                                    fontSize: 13,
                                    color: '#333',
                                    fontWeight: 'bold'
                                }
                            },
                            {
                                name: '移动轨迹',
                                type: 'lines',
                                coordinateSystem: 'geo',
                                data: lines,
                                lineStyle: {
                                    color: '#c8102e',
                                    width: 3,
                                    curveness: 0.3,
                                    opacity: 0.6
                                },
                                effect: {
                                    show: true,
                                    period: 4,
                                    trailLength: 0.2,
                                    symbol: 'arrow',
                                    symbolSize: 10,
                                    color: '#a00d24'
                                }
                            }
                        ]
                    };
                });
                
                chart.setOption({
                    baseOption: {
                        timeline: {
                            axisType: 'category',
                            autoPlay: true,
                            playInterval: 3000,
                            data: sortedYears.map(y => y + '年'),
                            bottom: 30,
                            height: 50,
                            label: { fontSize: 13, color: '#333' },
                            checkpointStyle: { color: '#c8102e', borderColor: '#c8102e' },
                            controlStyle: {
                                showPlayBtn: true,
                                showPrevBtn: true,
                                showNextBtn: true,
                                itemSize: 20,
                                itemGap: 12,
                                normal: { color: '#c8102e' },
                                emphasis: { color: '#a00d24' }
                            },
                            lineStyle: { color: '#c8102e' },
                            itemStyle: { color: '#c8102e' }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: function(params) {
                                if (params.componentSubType === 'scatter' && params.data) {
                                    return `<div style="padding: 8px;">
                                            <strong style="font-size: 14px;">${params.data.name}</strong><br/>
                                            <span style="color: #666;">年份：${params.data.year}年</span><br/>
                                            <span style="color: #666;">职位：${params.data.position}</span>
                                            </div>`;
                                }
                                return params.name;
                            }
                        },
                        geo: {
                            map: 'china',
                            roam: true,
                            zoom: 1.2,
                            center: [105, 36],
                            itemStyle: {
                                areaColor: '#f3f3f3',
                                borderColor: '#999',
                                borderWidth: 1
                            },
                            emphasis: {
                                itemStyle: { areaColor: '#e0e0e0' }
                            },
                            label: { show: false }
                        }
                    },
                    options: options
                });
            }
        }

        // 品级映射表
        const rankMap = {
            '太师': 1, '太傅': 1, '太保': 1, '大学士': 1,
            '少师': 2, '少傅': 2, '少保': 2, '各部院尚书': 2,
            '太子少师': 3, '各部院左右侍郎': 3, '内阁学士': 3,
            '翰林院侍读学士': 4, '各省巡抚': 4,
            '都察院左右副都御史': 5, '大理寺卿': 5, '各省按察使': 5,
            '光禄寺卿': 6, '太仆寺卿': 6,
            '通政使司副使': 7, '鸿胪寺卿': 7, '各省道员': 7,
            '翰林院侍读': 8, '翰林院侍讲': 8,
            '六科给事中': 9, '各部郎中': 9, '各省知府': 9,
            '翰林院编修': 10, '各部员外郎': 10, '各省知州': 10,
            '国子监司业': 11, '主事': 11, '各省通判': 11,
            '翰林院检讨': 12, '各省知县': 12,
            '知县': 13,
            '中书': 14,
            '县丞': 15,
            '主簿': 16,
            '未入流': 18
        };

        function getRankText(rank) {
            const rankTexts = {
                1: '正一品', 2: '从一品', 3: '正二品', 4: '从二品',
                5: '正三品', 6: '从三品', 7: '正四品', 8: '从四品',
                9: '正五品', 10: '从五品', 11: '正六品', 12: '从六品',
                13: '正七品', 14: '从七品', 15: '正八品', 16: '从八品',
                17: '正九品', 18: '从九品'
            };
            return rankTexts[Math.round(rank)] || '未知';
        }

        // 绘制品级变化图
        function drawRankChart(records) {
            const chartDom = document.getElementById('rankChart');
            const oldChart = echarts.getInstanceByDom(chartDom);
            if (oldChart) oldChart.dispose();
            const chart = echarts.init(chartDom);
            
            const sortedRecords = records.sort((a, b) => a['阳历年份'] - b['阳历年份']);
            const chartData = sortedRecords.map(record => {
                const position = record['官职一'] || '未知';
                const year = (record['阳历年份'] || '未知') + '年';
                let rank = 18;
                for (const [key, value] of Object.entries(rankMap)) {
                    if (position.includes(key)) {
                        rank = value;
                        break;
                    }
                }
                return { year, position, rank, rankText: getRankText(rank) };
            });

            chart.setOption({
                title: { text: '官职变化趋势', left: 'center', textStyle: { fontSize: 20, fontWeight: 'normal' } },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = chartData[params[0].dataIndex];
                        return `<strong>${data.year}</strong><br/>官职: ${data.position}<br/>品级: ${data.rankText}`;
                    }
                },
                grid: { left: '10%', right: '10%', bottom: '15%', top: '15%' },
                xAxis: {
                    type: 'category',
                    data: chartData.map(d => d.year),
                    axisLabel: { rotate: 45, interval: 0, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    inverse: true,
                    min: 0,
                    max: 19,
                    interval: 2,
                    axisLabel: { formatter: value => getRankText(value) },
                    name: '品级'
                },
                series: [{
                    type: 'line',
                    data: chartData.map(d => d.rank),
                    smooth: true,
                    lineStyle: { width: 3, color: '#c8102e' },
                    itemStyle: { color: '#c8102e', borderWidth: 2, borderColor: '#fff' },
                    symbolSize: 10,
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(200, 16, 46, 0.3)' },
                                { offset: 1, color: 'rgba(200, 16, 46, 0.05)' }
                            ]
                        }
                    }
                }]
            });
        }

        // 绘制社交网络图
        function drawNetworkChart(official, allData) {
            const chartDom = document.getElementById('networkChart');
            const oldChart = echarts.getInstanceByDom(chartDom);
            if (oldChart) oldChart.dispose();
            const chart = echarts.init(chartDom);
            
            const officialName = (official['姓'] || '') + (official['名'] || '');
            const nodes = [{ name: officialName, symbolSize: 60, category: 0, itemStyle: { color: '#c8102e' } }];
            const links = [];
            const categories = [
                { name: '本人' }, { name: '同机构关系' }, { name: '同乡关系' },
                { name: '同期关系' }, { name: '师生关系' }, { name: '家族关系' }
            ];

            const relatedOfficials = new Map();
            
            // 同机构
            allData.filter(item =>
                item['机构一'] && item['机构一'] === official['机构一'] &&
                (item['姓'] || '') + (item['名'] || '') !== officialName
            ).slice(0, 10).forEach(item => {
                const name = (item['姓'] || '') + (item['名'] || '');
                if (name && !relatedOfficials.has(name)) {
                    relatedOfficials.set(name, { category: 1, relation: '同机构' });
                    nodes.push({ name, symbolSize: 35, category: 1, itemStyle: { color: '#5470c6' } });
                    links.push({ source: officialName, target: name, value: '同机构', lineStyle: { color: '#5470c6' } });
                }
            });

            // 同乡
            allData.filter(item =>
                item['籍贯省'] && item['籍贯县'] &&
                item['籍贯省'] === official['籍贯省'] && item['籍贯县'] === official['籍贯县'] &&
                (item['姓'] || '') + (item['名'] || '') !== officialName
            ).slice(0, 10).forEach(item => {
                const name = (item['姓'] || '') + (item['名'] || '');
                if (name && !relatedOfficials.has(name)) {
                    relatedOfficials.set(name, { category: 2, relation: '同乡' });
                    nodes.push({ name, symbolSize: 35, category: 2, itemStyle: { color: '#91cc75' } });
                    links.push({ source: officialName, target: name, value: '同乡', lineStyle: { color: '#91cc75' } });
                }
            });

            // 同期
            allData.filter(item =>
                item['阳历年份'] && item['阳历年份'] === official['阳历年份'] &&
                (item['姓'] || '') + (item['名'] || '') !== officialName
            ).slice(0, 10).forEach(item => {
                const name = (item['姓'] || '') + (item['名'] || '');
                if (name && !relatedOfficials.has(name)) {
                    relatedOfficials.set(name, { category: 3, relation: '同期' });
                    nodes.push({ name, symbolSize: 35, category: 3, itemStyle: { color: '#fac858' } });
                    links.push({ source: officialName, target: name, value: '同期', lineStyle: { color: '#fac858' } });
                }
            });

            if (nodes.length === 1) {
                chart.setOption({
                    title: { text: '社交网络关系图', subtext: '未找到相关社交网络', left: 'center', top: 'middle' }
                });
                return;
            }

            chart.setOption({
                title: { text: '社交网络关系图', subtext: `共发现 ${nodes.length - 1} 个关联官员`, left: 'center' },
                tooltip: {
                    formatter: function(params) {
                        if (params.dataType === 'edge') {
                            return `<strong>${params.data.source}</strong> → <strong>${params.data.target}</strong><br/>关系: ${params.data.value}`;
                        }
                        return `<strong>${params.data.name}</strong>`;
                    }
                },
                legend: [{ data: categories.map(c => c.name), orient: 'vertical', left: 'left', top: 'middle' }],
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: links,
                    categories: categories,
                    roam: true,
                    draggable: true,
                    label: { show: true, position: 'right', fontSize: 11 },
                    force: { repulsion: 200, edgeLength: [100, 200], gravity: 0.1 },
                    emphasis: {
                        focus: 'adjacency',
                        label: { fontSize: 14, fontWeight: 'bold' },
                        lineStyle: { width: 4 }
                    },
                    lineStyle: { width: 2, curveness: 0.3 }
                }]
            });

            chart.on('click', function(params) {
                if (params.dataType === 'node' && params.data.name !== officialName) {
                    const clickedOfficial = allData.find(item => 
                        (item['姓'] || '') + (item['名'] || '') === params.data.name
                    );
                    if (clickedOfficial) {
                        showOfficialDetails(clickedOfficial);
                    }
                }
            });
        }

        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            setTimeout(() => {
                const chartMap = {
                    'timeline': 'timelineChart',
                    'map': 'mapChart',
                    'rank': 'rankChart',
                    'network': 'networkChart'
                };
                const chartId = chartMap[tabName];
                if (chartId) {
                    const chartInstance = echarts.getInstanceByDom(document.getElementById(chartId));
                    if (chartInstance) chartInstance.resize();
                }
            }, 100);
        }

        // 页面加载
        window.onload = function() {
            loadData();
        };

        // 响应式调整
        window.addEventListener('resize', function() {
            ['timelineChart', 'mapChart', 'rankChart', 'networkChart'].forEach(id => {
                echarts.getInstanceByDom(document.getElementById(id))?.resize();
            });
        });
    </script>
</body>
</html>
